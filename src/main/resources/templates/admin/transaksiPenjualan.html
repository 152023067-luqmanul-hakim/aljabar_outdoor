<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Transaksi Penjualan</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="flex h-screen bg-gray-100">
    <div th:replace="admin/fragments/navbar :: admin-navbar"></div>
    <div class="flex-1 p-8 flex flex-col h-full">
      <h1 class="text-3xl font-extrabold text-blue-700 mb-6">
        Transaksi Penjualan
      </h1>
      <div class="flex gap-6 h-full">
        <!-- Diproses -->
        <div class="flex-1 bg-white rounded-xl shadow p-4 overflow-y-auto">
          <h2 class="font-bold text-blue-600 mb-4">Diproses</h2>
          <div th:each="trx, iterStat : ${diproses}">
            <div
              class="mb-4 rounded p-4 shadow bg-white transition"
              style="position: relative"
            >
              <div class="flex items-center justify-between">
                <div>
                  <span class="font-semibold">ID:</span>
                  <span th:text="${trx.idTransaksi}"></span>
                  <span class="ml-2 font-semibold">User:</span>
                  <span th:text="${trx.user.username}"></span>
                  <span class="ml-2 font-semibold">Tanggal:</span>
                  <span
                    th:text="${#temporals.format(trx.tanggalTransaksi, 'dd-MM-yyyy HH:mm')}"
                  ></span>
                </div>
                <button
                  type="button"
                  class="ml-4 focus:outline-none"
                  onclick="toggleDetail(this)"
                  aria-label="Toggle Detail"
                >
                  <svg
                    class="w-5 h-5 transition-transform"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="M19 9l-7 7-7-7"
                    />
                  </svg>
                </button>
              </div>
              <!-- Card detail untuk Diproses -->
              <div class="hidden mt-2 text-sm text-gray-700">
                <div class="flex items-center justify-between">
                  <div>
                    <b>Status:</b> <span th:text="${trx.status}"></span>
                  </div>
                  <div class="flex items-center gap-2">
                    <select
                      th:data-id="${trx.idTransaksi}"
                      onchange="updateStatus(this)"
                      class="px-2 py-1 rounded border border-gray-300 text-gray-700 text-sm focus:outline-none focus:border-blue-500"
                    >
                      <option value="">Ubah Status</option>
                      <option value="Diproses">Diproses</option>
                      <option value="Diterima">Diterima</option>
                      <option value="Dibatalkan">Dibatalkan</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div
            th:if="${#lists.isEmpty(diproses)}"
            class="text-gray-400 text-center mt-8"
          >
            Tidak ada transaksi
          </div>
        </div>
        <!-- Diterima -->
        <div class="flex-1 bg-white rounded-xl shadow p-4 overflow-y-auto">
          <h2 class="font-bold text-green-600 mb-4">Diterima</h2>
          <div th:each="trx, iterStat : ${diterima}">
            <div
              class="mb-4 rounded p-4 shadow bg-white transition"
              style="position: relative"
            >
              <div class="flex items-center justify-between">
                <div>
                  <span class="font-semibold">ID :</span>
                  <span th:text="${trx.idTransaksi}"></span>
                  <span class="ml-2 font-semibold">User :</span>
                  <span th:text="${trx.user.username}"></span>
                  <span class="ml-2 font-semibold">Tanggal :</span>
                  <span
                    th:text="${#temporals.format(trx.tanggalTransaksi, 'dd-MM-yyyy HH:mm')}"
                  ></span>
                </div>
                <button
                  type="button"
                  class="ml-4 focus:outline-none"
                  onclick="toggleDetail(this)"
                  aria-label="Toggle Detail"
                >
                  <svg
                    class="w-5 h-5 transition-transform"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="M19 9l-7 7-7-7"
                    />
                  </svg>
                </button>
              </div>
              <!-- Card detail untuk Diterima -->
              <div class="hidden mt-2 text-sm text-gray-700">
                <div class="flex items-center justify-between">
                  <div>
                    <b>Status:</b> <span th:text="${trx.status}"></span>
                  </div>
                  <div class="flex items-center gap-2">
                    <select
                      th:data-id="${trx.idTransaksi}"
                      onchange="updateStatus(this)"
                      class="px-2 py-1 rounded border border-gray-300 text-gray-700 text-sm focus:outline-none focus:border-blue-500"
                    >
                      <option value="">Ubah Status</option>
                      <option value="Diproses">Diproses</option>
                      <option value="Diterima">Diterima</option>
                      <option value="Dibatalkan">Dibatalkan</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div
            th:if="${#lists.isEmpty(diterima)}"
            class="text-gray-400 text-center mt-8"
          >
            Tidak ada transaksi
          </div>
        </div>
        <!-- Dibatalkan -->
        <div class="flex-1 bg-white rounded-xl shadow p-4 overflow-y-auto">
          <h2 class="font-bold text-red-600 mb-4">Dibatalkan</h2>
          <div th:each="trx, iterStat : ${dibatalkan}">
            <div
              class="mb-4 rounded p-4 shadow bg-white transition"
              style="position: relative"
            >
              <div class="flex items-center justify-between">
                <div>
                  <span class="font-semibold">ID:</span>
                  <span th:text="${trx.idTransaksi}"></span>
                  <span class="ml-2 font-semibold">User:</span>
                  <span th:text="${trx.user.username}"></span>
                  <span class="ml-2 font-semibold">Tanggal:</span>
                  <span
                    th:text="${#temporals.format(trx.tanggalTransaksi, 'dd-MM-yyyy HH:mm')}"
                  ></span>
                </div>
                <button
                  type="button"
                  class="ml-4 focus:outline-none"
                  onclick="toggleDetail(this)"
                  aria-label="Toggle Detail"
                >
                  <svg
                    class="w-5 h-5 transition-transform"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="M19 9l-7 7-7-7"
                    />
                  </svg>
                </button>
              </div>
              <!-- Card detail untuk Dibatalkan -->
              <div class="hidden mt-2 text-sm text-gray-700">
                <div class="flex items-center justify-between">
                  <div>
                    <b>Status:</b> <span th:text="${trx.status}"></span>
                  </div>
                  <div class="flex items-center gap-2">
                    <select
                      th:data-id="${trx.idTransaksi}"
                      onchange="updateStatus(this)"
                      class="px-2 py-1 rounded border border-gray-300 text-gray-700 text-sm focus:outline-none focus:border-blue-500"
                    >
                      <option value="">Ubah Status</option>
                      <option value="Diproses">Diproses</option>
                      <option value="Diterima">Diterima</option>
                      <option value="Dibatalkan">Dibatalkan</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div
            th:if="${#lists.isEmpty(dibatalkan)}"
            class="text-gray-400 text-center mt-8"
          >
            Tidak ada transaksi
          </div>
        </div>
      </div>
    </div>
    <script>
      function toggleDetail(btn) {
        const card = btn.closest(".shadow.bg-white");
        const detail = card.querySelector(".mt-2");
        const isOpen = !detail.classList.contains("hidden");
        // Tutup semua detail
        document
          .querySelectorAll(".shadow.bg-white .mt-2")
          .forEach(function (d) {
            d.classList.add("hidden");
            const svg = d.parentElement.querySelector("button svg");
            if (svg) svg.style.transform = "";
          });
        // Jika sebelumnya tertutup, buka. Jika sudah terbuka, biarkan tertutup.
        if (!isOpen) {
          detail.classList.remove("hidden");
          btn.querySelector("svg").style.transform = "rotate(180deg)";
        }
      }

      function updateStatus(select) {
        if (!select.value) return;

        const id = select.getAttribute("data-id");
        const form = document.createElement("form");
        form.method = "POST";
        form.action = `/admin/transaksi/update-status/${id}`;

        const statusInput = document.createElement("input");
        statusInput.type = "hidden";
        statusInput.name = "status";
        statusInput.value = select.value;

        // Add CSRF token
        const csrf = document.createElement("input");
        csrf.type = "hidden";
        csrf.name = "_csrf";
        csrf.value = document
          .querySelector('meta[name="_csrf"]')
          .getAttribute("content");

        form.appendChild(statusInput);
        form.appendChild(csrf);
        document.body.appendChild(form);
        form.submit();
      }
    </script>

    <!-- Add CSRF token meta -->
    <meta name="_csrf" th:content="${_csrf.token}" />
  </body>
</html>
